<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>VK Updates Feed</title>
    <!-- VK Bridge: The library to interact with the VK client -->
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Simple styles for a clean look */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Dark Mode Card Style */
        .card {
            background-color: #2c2c2e; /* Dark gray for cards */
            border: 1px solid #444;
            border-radius: 12px;
            margin-bottom: 12px;
            padding: 12px;
        }
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .author-name {
            font-weight: 600;
            color: #f2f2f7; /* Light text for names */
        }
        .post-date {
            color: #8d8d93; /* Muted light text for dates */
            font-size: 0.8rem;
        }
        .post-text {
            line-height: 1.4;
            margin-bottom: 10px;
            color: #e5e5ea; /* Main post text color */
        }
        .post-image {
            width: 100%;
            border-radius: 8px;
            margin-top: 10px;
        }
        /* Video Container Styles */
        .post-video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            max-width: 100%;
            background: #000;
            border-radius: 8px;
            margin-top: 10px;
        }
        .post-video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        /* Clickable Thumbnail Style */
        .video-thumbnail-link {
            display: block;
            position: relative;
            margin-top: 10px;
        }
        .video-thumbnail-link::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        .play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none; /* Allows clicks to go to the link */
        }
        .play-icon svg {
            fill: white;
            width: 30px;
            height: 30px;
            margin-left: 4px; /* Optical alignment */
        }
        /* Style for the filter dropdown */
        #group-filter {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            background-color: #3a3a3c;
            color: #f2f2f7;
            border: 1px solid #444;
            margin-bottom: 16px;
        }
    </style>
</head>
<body class="bg-black">

    <div class="p-4 max-w-2xl mx-auto">
        <header class="text-center mb-4">
            <h1 class="text-2xl font-bold text-gray-100">Updates Feed</h1>
            <p class="text-gray-400">Your chronological feed of friends and groups.</p>
        </header>

        <!-- NEW: Dropdown for filtering by group -->
        <div id="filter-container">
             <select id="group-filter" class="hidden">
                <!-- Options will be populated by JavaScript -->
             </select>
        </div>

        <!-- Container for the feed items -->
        <main id="feed-container">
            <!-- Loading message will be shown initially -->
            <div id="loading-message" class="text-center text-gray-400 py-10">Loading your feed...</div>
        </main>

        <!-- NEW: Loading indicator for infinite scroll -->
        <div id="infinite-load-indicator" class="text-center text-gray-400 py-6 hidden">Loading more...</div>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        const APP_ID = 53964096; // Your App ID
        let accessToken = null;
        let nextFrom = ''; // Cursor for infinite scroll
        let isLoading = false; // Prevents multiple simultaneous loads
        let selectedGroupId = 'all'; // Currently selected filter

        // --- DOM ELEMENTS ---
        const feedContainer = document.getElementById('feed-container');
        const loadingMessage = document.getElementById('loading-message');
        const infiniteLoadIndicator = document.getElementById('infinite-load-indicator');
        const groupFilter = document.getElementById('group-filter');

        // --- 1. INITIALIZE THE MINI APP ---
        vkBridge.send('VKWebAppInit');

        // --- 2. AUTHENTICATION AND INITIAL DATA FETCH ---
        async function startApp() {
            if (APP_ID === 0) {
                loadingMessage.innerText = 'Error: Please set your APP_ID in the script.';
                return;
            }
            try {
                const tokenData = await vkBridge.send('VKWebAppGetAuthToken', {
                    app_id: APP_ID,
                    scope: 'friends,wall,groups,video'
                });
                accessToken = tokenData.access_token;
                if (accessToken) {
                    await fetchUserGroups(); // Fetch groups for the filter
                    await fetchNewsfeed(true); // Fetch initial feed
                }
            } catch (error) {
                console.error('Auth Error:', error);
                loadingMessage.innerText = 'Could not get authorization.';
            }
        }

        // --- 3. FETCH USER'S GROUPS FOR THE FILTER ---
        async function fetchUserGroups() {
            try {
                const groupsData = await vkBridge.send('VKWebAppCallAPIMethod', {
                    method: 'groups.get',
                    params: {
                        access_token: accessToken,
                        extended: 1, // Get full info
                        fields: 'name,photo_50',
                        v: '5.131'
                    }
                });
                populateGroupFilter(groupsData.response.items);
            } catch (error) {
                console.error('Failed to fetch groups:', error);
            }
        }

        // --- 4. POPULATE THE DROPDOWN FILTER ---
        function populateGroupFilter(groups) {
            groupFilter.innerHTML = '<option value="all">All Feeds</option>'; // Default option
            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = group.name;
                groupFilter.appendChild(option);
            });
            groupFilter.classList.remove('hidden'); // Show the filter
        }

        // --- 5. FETCH THE NEWS FEED FROM VK API (REFACTORED) ---
        async function fetchNewsfeed(isNewSearch = false) {
            if (isLoading) return; // Don't fetch if already loading
            isLoading = true;

            if (isNewSearch) {
                feedContainer.innerHTML = ''; // Clear feed for new search
                nextFrom = ''; // Reset pagination
                loadingMessage.classList.remove('hidden');
            } else {
                infiniteLoadIndicator.classList.remove('hidden'); // Show "Loading more..."
            }

            const params = {
                access_token: accessToken,
                filters: 'post,photo,video',
                count: 30, // Get 30 items at a time
                extended: 1,
                v: '5.131'
            };

            // Add pagination cursor if it exists
            if (nextFrom) {
                params.start_from = nextFrom;
            }

            // Add group filter if a group is selected
            if (selectedGroupId !== 'all') {
                // The 'g' prefix is required by the API for group source_ids
                params.source_ids = 'g' + selectedGroupId;
            }

            try {
                const feedData = await vkBridge.send('VKWebAppCallAPIMethod', {
                    method: 'newsfeed.get',
                    params: params
                });

                if (feedData.response) {
                    renderFeed(feedData.response);
                    nextFrom = feedData.response.next_from; // Update cursor for next load
                }
            } catch (error) {
                console.error('API Error:', error);
                feedContainer.innerHTML += '<div class="text-center text-red-400 py-10">Failed to load feed data.</div>';
            } finally {
                isLoading = false;
                loadingMessage.classList.add('hidden');
                infiniteLoadIndicator.classList.add('hidden');
            }
        }

        // --- 6. RENDER THE FEED ON THE SCREEN (APPENDS ITEMS) ---
        function renderFeed(response) {
            const { items, profiles, groups } = response;

            if (items.length === 0 && feedContainer.innerHTML === '') {
                feedContainer.innerHTML = '<div class="text-center text-gray-400 py-10">Nothing new to show.</div>';
                return;
            }

            items.forEach(item => {
                let author = null;
                if (item.source_id > 0) {
                    author = profiles.find(p => p.id === item.source_id);
                } else {
                    author = groups.find(g => g.id === -item.source_id);
                }

                if (!author) return;

                const card = document.createElement('div');
                card.className = 'card';
                const postDate = new Date(item.date * 1000).toLocaleString();
                let contentHTML = '';

                const renderVideo = (videoObject) => {
                    if (videoObject.player) {
                        return `<div class="post-video-container"><iframe src="${videoObject.player}" frameborder="0" allowfullscreen></iframe></div>`;
                    } else if (videoObject.image) {
                        const videoLink = `https://vk.com/video${videoObject.owner_id}_${videoObject.id}`;
                        const bestThumbnail = videoObject.image.sort((a, b) => b.width - a.width)[0];
                        return `<a href="${videoLink}" target="_blank" class="video-thumbnail-link"><img src="${bestThumbnail.url}" class="post-image" alt="Video thumbnail"><div class="play-icon"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg></div></a>`;
                    }
                    return '';
                };

                if (item.type === 'post') {
                    if (item.text) contentHTML += `<div class="post-text">${item.text.replace(/\n/g, '<br>')}</div>`;
                    if (item.attachments) {
                        const photo = item.attachments.find(att => att.type === 'photo');
                        const video = item.attachments.find(att => att.type === 'video');
                        if (photo) {
                            const bestSize = photo.photo.sizes.sort((a, b) => b.width - a.width)[0];
                            contentHTML += `<img src="${bestSize.url}" class="post-image" alt="Post attachment">`;
                        } else if (video) {
                            contentHTML += renderVideo(video.video);
                        }
                    }
                } else if (item.type === 'photo' && item.photos) {
                    const photoItem = item.photos.items[0];
                    const bestSize = photoItem.sizes.sort((a, b) => b.width - a.width)[0];
                    contentHTML += `<img src="${bestSize.url}" class="post-image" alt="New photo">`;
                } else if (item.type === 'video' && item.video) {
                    contentHTML += renderVideo(item.video.items[0]);
                }

                if (contentHTML) {
                    card.innerHTML = `<div class="card-header"><img src="${author.photo_100 || author.photo_200}" class="avatar" alt="Author avatar"><div><div class="author-name">${author.name || (author.first_name + ' ' + author.last_name)}</div><div class="post-date">${postDate}</div></div></div>${contentHTML}`;
                    feedContainer.appendChild(card);
                }
            });
        }

        // --- 7. EVENT LISTENERS ---
        // Listen for changes on the group filter
        groupFilter.addEventListener('change', (event) => {
            selectedGroupId = event.target.value;
            fetchNewsfeed(true); // Trigger a new search
        });

        // Listen for scrolling to trigger infinite load
        window.addEventListener('scroll', () => {
            // Check if user is near the bottom of the page
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500 && !isLoading) {
                fetchNewsfeed(false); // Fetch more items, not a new search
            }
        });

        // Start the application
        startApp();
    </script>
</body>
</html>
