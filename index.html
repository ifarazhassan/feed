<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>VK Updates Feed</title>
    <!-- VK Bridge: The library to interact with the VK client -->
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Simple styles for a clean look */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Dark Mode Card Style */
        .card {
            background-color: #2c2c2e; /* Dark gray for cards */
            border: 1px solid #444;
            border-radius: 12px;
            margin-bottom: 12px;
            padding: 12px;
        }
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .author-name {
            font-weight: 600;
            color: #f2f2f7; /* Light text for names */
        }
        .post-date {
            color: #8d8d93; /* Muted light text for dates */
            font-size: 0.8rem;
        }
        .post-text {
            line-height: 1.4;
            margin-bottom: 10px;
            color: #e5e5ea; /* Main post text color */
        }
        .post-image, .video-thumbnail-image {
            width: 100%;
            border-radius: 8px;
            margin-top: 10px;
        }
        /* Clickable Thumbnail Style */
        .video-thumbnail-link {
            display: block;
            position: relative;
            margin-top: 10px;
        }
        .video-thumbnail-link::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }
        .video-thumbnail-link:hover::after {
             background: rgba(0, 0, 0, 0.1);
        }
        .play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none; /* Allows clicks to go to the link */
        }
        .play-icon svg {
            fill: white;
            width: 30px;
            height: 30px;
            margin-left: 4px; /* Optical alignment */
        }
        /* Style for the filter dropdown */
        #group-filter {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            background-color: #3a3a3c;
            color: #f2f2f7;
            border: 1px solid #444;
            margin-bottom: 16px;
        }
    </style>
</head>
<body class="bg-black">

    <div class="p-4 max-w-2xl mx-auto">
        <header class="text-center mb-4">
            <h1 class="text-2xl font-bold text-gray-100">Updates Feed</h1>
            <p class="text-gray-400">Your chronological feed of friends and groups.</p>
        </header>

        <div id="filter-container">
             <select id="group-filter" class="hidden"></select>
        </div>

        <main id="feed-container"></main>

        <div id="infinite-load-indicator" class="text-center text-gray-400 py-6 hidden">Loading more...</div>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        const APP_ID = 53964096; // Your App ID
        let accessToken = null;
        let newsfeedNextFrom = ''; // Cursor for newsfeed.get
        let videoOffset = 0; // Offset for video.get
        let isLoading = false;
        let selectedGroupId = 'all';
        let userGroups = [];

        // --- DOM ELEMENTS ---
        const feedContainer = document.getElementById('feed-container');
        const infiniteLoadIndicator = document.getElementById('infinite-load-indicator');
        const groupFilter = document.getElementById('group-filter');

        // --- 1. INITIALIZE THE MINI APP ---
        vkBridge.send('VKWebAppInit');

        // --- 2. AUTHENTICATION AND INITIAL DATA FETCH ---
        async function startApp() {
            try {
                await vkBridge.send("VKWebAppSetViewSettings", { "pull_to_refresh": "enabled" });
                const tokenData = await vkBridge.send('VKWebAppGetAuthToken', { app_id: APP_ID, scope: 'friends,wall,groups,video' });
                accessToken = tokenData.access_token;
                if (accessToken) {
                    await fetchUserGroups();
                    await fetchContent(true);
                }
            } catch (error) {
                console.error('Auth Error:', error);
                feedContainer.innerHTML = '<div class="text-center text-red-400 py-10">Could not get authorization.</div>';
            }
        }

        // --- 3. FETCH USER'S GROUPS FOR THE FILTER ---
        async function fetchUserGroups() {
            try {
                const groupsData = await vkBridge.send('VKWebAppCallAPIMethod', {
                    method: 'groups.get',
                    params: { access_token: accessToken, extended: 1, fields: 'name,photo_50', v: '5.131' }
                });
                userGroups = groupsData.response.items;
                populateGroupFilter(userGroups);
            } catch (error) {
                console.error('Failed to fetch groups:', error);
            }
        }

        // --- 4. POPULATE THE DROPDOWN FILTER ---
        function populateGroupFilter(groups) {
            groupFilter.innerHTML = '<option value="all">All Feeds</option>';
            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = group.name;
                groupFilter.appendChild(option);
            });
            groupFilter.classList.remove('hidden');
        }
        
        // --- 5. MASTER FETCH FUNCTION ---
        async function fetchContent(isNewSearch = false) {
            if (isLoading) return;
            isLoading = true;

            if (isNewSearch) {
                feedContainer.innerHTML = '';
                newsfeedNextFrom = '';
                videoOffset = 0;
            }

            const loadingIndicator = isNewSearch ? document.createElement('div') : infiniteLoadIndicator;
            if (isNewSearch) {
                loadingIndicator.className = 'text-center text-gray-400 py-10';
                loadingIndicator.textContent = 'Loading...';
                feedContainer.appendChild(loadingIndicator);
            } else {
                loadingIndicator.classList.remove('hidden');
            }

            try {
                if (selectedGroupId === 'all') {
                    await fetchNewsfeedApi();
                } else {
                    await fetchCommunityVideosApi();
                }
            } catch (error) {
                console.error('Content Fetch Error:', error);
                feedContainer.innerHTML = '<div class="text-center text-red-400 py-10">Failed to load data.</div>';
            } finally {
                isLoading = false;
                if (isNewSearch) loadingIndicator.remove();
                else loadingIndicator.classList.add('hidden');
            }
        }

        // --- 6. API CALLERS ---
        async function fetchNewsfeedApi() {
            const params = { access_token: accessToken, filters: 'post,photo,video', count: 30, extended: 1, v: '5.131' };
            if (newsfeedNextFrom) params.start_from = newsfeedNextFrom;

            const data = await vkBridge.send('VKWebAppCallAPIMethod', { method: 'newsfeed.get', params });
            if (data.response) {
                renderNewsfeed(data.response);
                newsfeedNextFrom = data.response.next_from;
            }
        }

        async function fetchCommunityVideosApi() {
            const params = {
                access_token: accessToken,
                owner_id: -parseInt(selectedGroupId),
                count: 50,
                offset: videoOffset,
                extended: 1,
                v: '5.131'
            };

            const data = await vkBridge.send('VKWebAppCallAPIMethod', { method: 'video.get', params });
            if (data.response && data.response.items.length > 0) {
                renderCommunityVideos(data.response);
                videoOffset += data.response.items.length;
            }
        }

        // --- 7. RENDERERS ---
        function renderNewsfeed(response) {
            const { items, profiles, groups } = response;
            if (items.length === 0 && feedContainer.innerHTML === '') {
                feedContainer.innerHTML = '<div class="text-center text-gray-400 py-10">Nothing new to show.</div>';
            }
            items.forEach(item => {
                const author = (item.source_id > 0) ? profiles.find(p => p.id === item.source_id) : groups.find(g => g.id === -item.source_id);
                if (!author) return;
                const card = createCard(author, item.date, item);
                if (card) feedContainer.appendChild(card);
            });
        }

        function renderCommunityVideos(response) {
            const groupInfo = userGroups.find(g => g.id == selectedGroupId);
            if (response.items.length === 0 && feedContainer.innerHTML === '') {
                feedContainer.innerHTML = '<div class="text-center text-gray-400 py-10">No videos found in this community.</div>';
            }
            response.items.forEach(videoItem => {
                const card = createCard(groupInfo, videoItem.date, videoItem, true);
                if (card) feedContainer.appendChild(card);
            });
        }

        // --- 8. CARD CREATION HELPER ---
        function createCard(author, date, item, isDirectVideo = false) {
            const card = document.createElement('div');
            card.className = 'card';
            const postDate = new Date(date * 1000).toLocaleString();
            let contentHTML = '';

            // UPDATED: This function now ONLY creates a clickable thumbnail.
            const renderVideo = (videoObject) => {
                // Check if there is an image thumbnail available for the video
                if (videoObject.image || videoObject.first_frame) {
                    const videoLink = `https://vk.com/video${videoObject.owner_id}_${videoObject.id}`;
                    // Use 'image' for newsfeed videos, 'first_frame' for direct video.get results
                    const thumbnail = videoObject.image || videoObject.first_frame;
                    const bestThumbnail = thumbnail.sort((a, b) => b.width - a.width)[0];
                    return `<a href="${videoLink}" target="_blank" class="video-thumbnail-link"><img src="${bestThumbnail.url}" class="video-thumbnail-image" alt="Video thumbnail"><div class="play-icon"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg></div></a>`;
                }
                return ''; // Return empty if no thumbnail is available
            };

            if (isDirectVideo) {
                contentHTML += `<div class="post-text">${item.title.replace(/\n/g, '<br>')}</div>`;
                contentHTML += renderVideo(item);
            } else {
                if (item.type === 'post') {
                    if (item.text) contentHTML += `<div class="post-text">${item.text.replace(/\n/g, '<br>')}</div>`;
                    if (item.attachments) {
                        const photo = item.attachments.find(att => att.type === 'photo');
                        const video = item.attachments.find(att => att.type === 'video');
                        if (photo) contentHTML += `<img src="${photo.photo.sizes.sort((a,b)=>b.width-a.width)[0].url}" class="post-image" alt="Post attachment">`;
                        else if (video) contentHTML += renderVideo(video.video);
                    }
                } else if (item.type === 'photo' && item.photos) {
                    contentHTML += `<img src="${item.photos.items[0].sizes.sort((a,b)=>b.width-a.width)[0].url}" class="post-image" alt="New photo">`;
                } else if (item.type === 'video' && item.video) {
                    contentHTML += renderVideo(item.video.items[0]);
                }
            }

            if (contentHTML) {
                card.innerHTML = `<div class="card-header"><img src="${author.photo_50}" class="avatar" alt="Author avatar"><div><div class="author-name">${author.name}</div><div class="post-date">${postDate}</div></div></div>${contentHTML}`;
                return card;
            }
            return null;
        }

        // --- 9. EVENT LISTENERS ---
        groupFilter.addEventListener('change', (event) => {
            selectedGroupId = event.target.value;
            fetchContent(true);
        });

        window.addEventListener('scroll', () => {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500 && !isLoading) {
                fetchContent(false);
            }
        });

        // --- 10. PULL-TO-REFRESH LISTENER ---
        vkBridge.subscribe(async (e) => {
            if (e.detail.type === 'VKWebAppUpdateConfig') {
                await fetchContent(true);
                await vkBridge.send("VKWebAppStopPullToRefresh");
            }
        });

        // Start the application
        startApp();
    </script>
</body>
</html>
